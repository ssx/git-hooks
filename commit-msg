#!/usr/bin/env bash
# ─────────────────────────────────────────────────────────────────────────────
# Repository : https://github.com/ssx/git-hooks
# Author     : Scott Robinson (https://github.com/ssx)
# License    : MIT — see LICENSE for details
# ─────────────────────────────────────────────────────────────────────────────
#
# commit-msg hook: Validates Conventional Commits format
# See: https://www.conventionalcommits.org/

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip merge commits
if echo "$COMMIT_MSG" | grep -qE "^Merge "; then
  exit 0
fi

# Skip revert commits (auto-generated by `git revert`)
if echo "$COMMIT_MSG" | grep -qE "^Revert \""; then
  exit 0
fi

# Conventional Commits pattern:
#   <type>[optional scope][optional !]: <description>
#
# Types defined by the spec + common extensions
PATTERN='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-zA-Z0-9_/. -]+\))?(!)?: .+'

if ! echo "$COMMIT_MSG" | grep -qE "$PATTERN"; then
  echo ""
  echo "  ERROR: Commit message does not follow Conventional Commits format."
  echo ""
  echo "  Format:  <type>[optional scope][optional !]: <description>"
  echo ""
  echo "  Types:   feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
  echo ""
  echo "  Examples:"
  echo "    feat: add user authentication"
  echo "    fix(auth): handle expired tokens correctly"
  echo "    feat!: remove deprecated v1 API"
  echo "    docs(readme): update installation instructions"
  echo "    chore(deps): bump lodash to 4.17.21"
  echo ""
  echo "  Your message: $(head -1 "$COMMIT_MSG_FILE")"
  echo ""
  echo "  See: https://www.conventionalcommits.org/"
  echo ""
  exit 1
fi

exit 0
